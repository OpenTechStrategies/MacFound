---

- name: Setup installation directory
  file:
    path: "{{ mediawiki_install_directory }}"
    state: directory

- name: Download MediaWiki
  get_url:
    url: https://releases.wikimedia.org/mediawiki/1.33/mediawiki-1.33.0.tar.gz
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0.tar.gz"
    checksum: sha256:8335a2d8740c5dd5919a480b74c3d8e19f23a68b396df48c2d77646272fdcd67

- name: Extract MediaWiki tarball
  unarchive:
    src: "{{ mediawiki_install_directory }}/mediawiki-1.33.0.tar.gz"
    dest: "{{ mediawiki_install_directory }}/"
    remote_src: yes
    creates: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/"

- name: Install MW with Composer
  command: composer install --no-dev
  args:
    chdir: "{{ mediawiki_install_directory }}/mediawiki-1.33.0"

- name: Install EmbedVideo
  unarchive:
    src: "{{ playbook_dir }}/../../thirdparty/extensions/EmbedVideo-v2.8.0.zip"
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/"

- name: Patch EmbedVideo
  patch:
    src: EmbedVideoIframeTitle.patch
    basedir: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/EmbedVideo-v2.8.0/"

- name: Install PluggableAuth
  unarchive:
    src: "{{ playbook_dir }}/../../thirdparty/extensions/PluggableAuth-REL1_33-a69f626.tar.gz"
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/"

- name: Install SimpleSAML extension
  unarchive:
    src: "{{ playbook_dir }}/../../thirdparty/extensions/SimpleSAMLphp-REL1_33-7d91f27.tar.gz"
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/"

- name: Install Collection
  unarchive:
    src: "{{ playbook_dir }}/../../thirdparty/extensions/Collection-REL1_33-8566dd1.tar.gz"
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/"

- name: Checkout PickSome
  git:
    repo: https://github.com/OpenTechStrategies/PickSome
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/PickSome/"
    version: 59df890

- name: Checkout ActivityLog
  git:
    repo: https://github.com/OpenTechStrategies/ActivityLog
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/ActivityLog/"
    version: 27e9191

- name: Checkout SimpleFavorites
  git:
    repo: https://github.com/OpenTechStrategies/SimpleFavorites
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/SimpleFavorites/"
    version: 59fed33

- name: Checkout TeamComments
  git:
    repo: https://github.com/OpenTechStrategies/TeamComments
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/TeamComments/"
    version: 450bff7

- name: Checkout Torque
  git:
    repo: https://github.com/OpenTechStrategies/torque
    dest: "{{ mediawiki_install_directory }}/torque/"
    version: e9e787b

- name: Link TorqueDataConnect
  file:
    src: "{{ mediawiki_install_directory }}/torque/TorqueDataConnect/"
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/TorqueDataConnect"
    state: link

- name: Create Wiki
  command: "php {{ mediawiki_install_directory }}/mediawiki-1.33.0/maintenance/install.php --dbtype=mysql --dbserver=localhost --dbuser=wikiuser --dbpass=\"{{ db_password }}\" --dbname=Climate2030  --scriptpath=\"/Climate2030\" --lang=en --pass=\"{{ mediawiki_admin_password }}\" \"Climate2030\" \"admin\""
  args:
    creates: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"

- name: Enable EmbedVideo
  lineinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    line: "wfLoadExtension('EmbedVideo-v2.8.0');"

- name: Enable PluggableAuth
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} ANSIBLE PLUGABLE AUTH CONFIG"
    block: |
      wfLoadExtension( 'PluggableAuth' );
      $wgPluggableAuth_EnableAutoLogin = true;
      $wgPluggableAuth_EnableLocalLogin = true;
      $wgPluggableAuth_EnableLocalProperties = false;
      $wgPluggableAuth_ButtonLabel = "Log In Using MacArthur SSO";
      $wgInvalidUsernameCharacters = "";

- name: Enable SimpleSAMLphp extension
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} ANSIBLE SIMPLE SAML PHP CONFIG"
    block: |
      wfLoadExtension( 'SimpleSAMLphp' );
      $wgSimpleSAMLphp_SyncAllGroups_LocallyManaged = ["sysop", "DecisionMakers"];
      $wgSimpleSAMLphp_InstallDir = '{{ simplesaml_install_directory }}/simplesamlphp-1.18.4';
      $wgSimpleSAMLphp_AuthSourceId = '{{ simplesaml_okta_metadata_name }}';
      $wgSimpleSAMLphp_RealNameAttribute = ['firstName', 'lastName'];
      $wgSimpleSAMLphp_EmailAttribute = 'email';
      $wgSimpleSAMLphp_UsernameAttribute = 'username';
      $wgSimpleSAMLphp_GroupMap = [
        'sysop' => ['groups' => ['LFC Torque Admin', 'LFC Staff']],
        'DecisionMakers' => ['groups' => ['LFC Decision Makers']]
      ];

      $wgSimpleSAMLphp_SyncAllGroups_GroupNameModificationCallback = function($origGroupName){
        # Remove spaces
        return preg_replace('/\s/', '', $origGroupName);
      };
      $wgSimpleSAMLphp_AttributeProcessorFactories = [
        "MediaWiki\\Extension\\SimpleSAMLphp\\AttributeProcessor\\SyncAllGroups::factory"
      ];

- name: Enable Collection
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} ANSIBLE COLLECTION CONFIG"
    block: |
      require_once "$IP/extensions/Collection/Collection.php";
      $wgCollectionMWServeURL = "http://127.0.0.1:8899";
      $wgCollectionMaxArticles = 250;
      $wgEnableApi = true;
      $wgCollectionFormats = array( 'rl' => 'PDF',);
      $wgCollectionPortletFormats = [];
      $wgCollectionDisableDownloadSection = false;
      $wgHooks['ApiBeforeMain'][] = function($main) {
        global $wgTorqueDataConnectGroup, $wgTorqueDataConnectRenderToHTML, $wgTorqueDataConnectView;
        if($main->getUser() && strtolower($main->getUser()->getName()) == "{{ mediawiki_mwlib_username }}") {
          $wgTorqueDataConnectRenderToHTML = false;
          $tdcinfo = $main->getRequest()->getText("tdcinfo", false);
          list($wgTorqueDataConnectGroup, $wgTorqueDataConnectView) = explode("|", $tdcinfo);
        }
      };
      $wgHooks['BeforeInitialize'][] = function(&$title, &$article = null, &$output, &$user, $request, $mediaWiki) {
        global $wgCollectionMWServeCredentials;
        $group = TorqueDataConnectConfig::getValidGroup($user);
        $view = TorqueDataConnectConfig::getCurrentView();
        $wgCollectionMWServeCredentials = "{{ mediawiki_mwlib_username }}:${group}|${view}:{{ mediawiki_mwlib_password }}";
      };

- name: Enable TorqueDataConnect
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} ANSIBLE TORQUEDATACONNECT CONFIG"
    block: |
      define("TORQUE_CONFIG", 4000);
      define("TORQUE_CONFIG_TALK", 4001);
      $wgExtraNamespaces[TORQUE_CONFIG] = "TorqueConfig";
      $wgExtraNamespaces[TORQUE_CONFIG_TALK] = "TorqueConfig_talk";
      $wgNamespaceProtection[TORQUE_CONFIG] = array("edittorqueconfig");
      $wgTorqueDataConnectSheetName = "Climate2030";
      $wgTorqueDataConnectWikiKey = "Climate2030";
      $wgTorqueDataConnectConfigPage = "TorqueConfig:MainConfig";
      $wgTorqueDataConnectNotFoundMessage = "This proposal has been disqualified in admin, peer, or expert review.";
      wfLoadExtension('TorqueDataConnect');

- name: Enable SimpleFavorites
  lineinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    line: "wfLoadExtension('SimpleFavorites');"

- name: Enable TeamComments
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} ANSIBLE TEAMCOMMENTS CONFIG"
    block: |
      wfLoadExtension('TeamComments');
      $wgTeamCommentsCheatSheetLocation = "Wiki_Markup_Cheat_Sheet";
      $wgTeamCommentsUserPseudonymizer = function($username) {
        return "Pseudonymous User #" . TorqueDataConnectUserLookup::lookupByUsername($username)->{"id"};
      };

- name: Enable Uploading
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} UPLOAD CONFIG"
    block: |
      $wgEnableUploads = true;
      $wgFileExtensions = array_merge($wgFileExtensions, array('doc', 'docx', 'html', 'pdf', 'xlsx'));
      $wgFileBlacklist = array();
      $wgMimeTypeBlacklist = array();
      $wgStrictFileExtensions = false;
      $wgTrustedMediaFormats = array('application/zip', 'text/html');
      $wgVerifyMimeType = false;
      $wgAllowJavaUploads = true;
      $wgCheckFileExtensions = false;
      $wgGroupPermissions['bot']['edit'] = true;
      $wgGroupPermissions['bot']['upload'] = true;
      $wgGroupPermissions['bot']['torquedataconnect-admin'] = true;
      $wgGroupPermissions['autoconfirmed']['reupload'] = true;

- name: Set TOC depth
  lineinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    line: $wgMaxTocLevel = 2;

- name: Disable Collection Warning 1
  replace:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/Collection/Collection.body.php"
    regexp: '^(\t.*MessageBoxHelper::renderWarningBoxes.*)$'
    replace: '#\1'

- name: Disable Collection Warning 2
  replace:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/Collection/templates/CollectionPageTemplate.php"
    regexp: '^(\t.*MessageBoxHelper::renderWarningBoxes.*)$'
    replace: '#\1'

- name: Remove Collection Book Text
  replace:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/extensions/Collection/i18n/en.json"
    regexp: '\t"coll-book_creator_intro": "<big>With the ''''book creator'''' you can create a book containing wiki pages of your choice. You can export the book in different formats \(for example PDF or ODF\) or order a printed copy.</big>",'
    replace: '\t"coll-book_creator_intro": "<big>With the ''''book creator'''' you can create a book containing wiki pages of your choice. You can export the book in different formats (for example PDF or ODF).</big>",'

- name: Install ActivityLog Configuration
  copy:
    src: ActivityLogConfiguration
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/"

- name: Enable ActivityLog
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} ANSIBLE ACTIVITYLOG CONFIG"
    block: |
      wfLoadExtension('ActivityLog');
      $wgMessagesDirs['ActivityLogConfiguration'] = 'ActivityLogConfiguration/i18n';
      $wgActivityLogHooksToWatch["ArticleViewHeader"] = function ($article) {
        $referrer = $_SERVER['HTTP_REFERER'];
        $ourServer = "http://torque.leverforchange.org";

        if($referrer && $ourServer == substr($referrer, 0, strlen($ourServer))) {
          return array($article->getContext()->getUser(),
            $article->getTitle(),
            "activitylog-articleviewheader-with-referrer",
            $_SERVER['HTTP_REFERER']
          );
        } else {
          return array($article->getContext()->getUser(),
            $article->getTitle(),
            "activitylog-articleviewheader"
          );
        }
      };

      $wgActivityLogHooksToWatch["UserLoginComplete"] = function(&$user, &$inject_html, $direct) {
        global $wgTitle;
        return array($user, $wgTitle, "activitylog-userlogin");
      };

      $wgActivityLogHooksToWatch["PageContentSave"] = function($wikiPage, $user, $content, &$summary, $isMinor, $isWatch, $section, $flags, $status) {
        return array($user, $wikiPage->getTitle(), "activitylog-articlesavepage");
      };

- name: Enable PickSome
  blockinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    marker: "## {mark} ANSIBLE PICKSOME CONFIG"
    block: |
      # While this next line should be taken care of in extenions, and indeed
      # it is, because this extension is loaded via wfLoadExtension, and because
      # Collection is loaded the old way, the sidebar before output is called
      # preferring Collection, placing it higher on the siderbar than PickSome.
      #
      # This was requested to be changed, and the most straightforward way is
      # to add it to the hook directly in LocalSettings
      $wgHooks['SidebarBeforeOutput'][] = 'PickSomeHooks::onSidebarBeforeOutput';
      wfLoadExtension('PickSome');
      $wgPickSomeNumberOfPicks = 15;
      # This may not be performant and require caching if number of users/page hits
      # becomes large.
      $wgPickSomePage = function($title) {
        $eligibleWildCardsTitle = Title::newFromText("TorqueConfig:ValidProposals");
        if($eligibleWildCardsTitle->exists()) {
          $page = new WikiPage($eligibleWildCardsTitle);
          $valid_pages = [];
          preg_match_all("/\\[\\[([^\\]]*)\\]\\]/", $page->getContent()->getText(), $valid_pages);
          foreach($valid_pages[1] as $valid_page) {
            if($title->equals(Title::newFromText($valid_page))) {
              return true;
            }
          }
          return false;
        } else {
          return false;
        }
      };

      $wgPickSomeSortFunction = function($t1, $t2) {
        $text1 = $t1->getText();
        $text2 = $t2->getText();

        $text1 = preg_replace("/^\\W/", "", $text1);
        $text2 = preg_replace("/^\\W/", "", $text2);
        return $text1 > $text2;
      };

      $picksomeOverrideMessage = [
        "picksome-all" => "Everyone's Finalist Candidates",
        "picksome-title" => "Finalist Candidates",
        "picksome-choices" => "Finalist Candidate Choices",
        "picksome-my-picks" => "My Finalist Candidates",
        "picksome-unpick" => "Deselect",
        "picksome-pick" => "Select this page",
        "picksome-no-picks" => "No Finalist Candidates",
        "picksome-current" => "Current Page",
        "picksome-view-all" => "View Everyone's Finalist Candidates",
        "picksome-global-list" => "Global Finalist Candidate List",
        "picksome-remove-below" => "To select the current page, remove one below",
        "picksome-stop" => "Stop Selecting",
        "picksome-close-window" => "Close Window",
        "picksome-start" => "Start Selecting",
      ];
      $wgHooks['MessagesPreLoad'][] = function($title, &$message, $code) {
        global $picksomeOverrideMessage;
        if(array_key_exists(strtolower($title), $picksomeOverrideMessage)) {
          $message = $picksomeOverrideMessage[strtolower($title)];
        }
      };

- name: Disable MediaWiki Cache
  # When the cache is enabled, on AWS, with the default setting,
  # the following createAndPromote.php command fails due to cache timeout.
  # The reason isn't clear, but for now, this will fix it.
  lineinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    line: $wgMainCacheType = CACHE_NONE;

- name: Create mwlib user
  command: "php {{ mediawiki_install_directory }}/mediawiki-1.33.0/maintenance/createAndPromote.php --force --dbuser=wikiuser --dbpass=\"{{ db_password }}\" \"{{ mediawiki_mwlib_username }}\" \"{{ mediawiki_mwlib_password }}\""

- name: Create csv2wiki user
  command: "php {{ mediawiki_install_directory }}/mediawiki-1.33.0/maintenance/createAndPromote.php --bot --force --dbuser=wikiuser --dbpass=\"{{ db_password }}\" \"{{ mediawiki_csv2wiki_username }}\" \"{{ mediawiki_csv2wiki_password }}\""

- name: Set Group Permissions
  blockinfile:
    marker: "## {mark} ANSIBLE GROUP PERMISSIONS CONFIG"
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    block: |
      $wgGroupPermissions['*']['read'] = false;
      $wgGroupPermissions['bot']['protect'] = true;
      $wgRestrictionLevels[] = 'generated';
      $wgGroupPermissions['bot']['generated'] = true;

      # Permissions that we want sysops/admins to have that
      # but not for staff go here
      $wgGroupPermissions['sysop']['generated'] = true;
      $wgGroupPermissions['sysop']['edittorqueconfig'] = true;
      $wgGroupPermissions['sysop']['torquedataconnect-admin'] = true;

      # Groups requested specifically by LFC.
      $wgGroupPermissions['LFCConsultingPartners']['read'] = true;
      $wgGroupPermissions['LFCConsultingPartners']['torquedataconnect-edit'] = true;
      $wgGroupPermissions['LFCResearchPartners']['read'] = true;
      $wgGroupPermissions['LFCEvaluators']['read'] = true;

      # These are OTS Torque Standard Groups
      $wgGroupPermissions['OutsideReviewers']['read'] = true;
      $wgGroupPermissions['Staff']['read'] = true;
      $wgGroupPermissions['PseudoDecisionMakers']['read'] = true;
      $wgGroupPermissions['DecisionMakers']['read'] = true;

      # Disable teamcomments for users on this wiki by default.
      $wgGroupPermissions['*']['teamcomment'] = false;
      $wgGroupPermissions['*']['teamcommentseeusernames'] = false;

      # Then enable teamcomments for the groups that should be leaving comments
      $wgGroupPermissions['Staff']['teamcomment'] = true;
      $wgGroupPermissions['PseudoDecisionMakers']['teamcomment'] = true;
      $wgGroupPermissions['DecisionMakers']['teamcomment'] = true;
      $wgGroupPermissions['sysop']['teamcomment'] = true;
      $wgGroupPermissions['LFCResearchPartners']['teamcomment'] = true;
      $wgGroupPermissions['LFCEvaluators']['teamcomment'] = true;

      # Allow some groups to see usernames
      $wgGroupPermissions['Staff']['teamcommentseeusernames'] = true;
      $wgGroupPermissions['PseudoDecisionMakers']['teamcommentseeusernames'] = true;
      $wgGroupPermissions['DecisionMakers']['teamcommentseeusernames'] = true;
      $wgGroupPermissions['sysop']['teamcommentseeusernames'] = true;

      # PickSome permissions
      $wgGroupPermissions['DecisionMakers']['picksome'] = true;
      $wgGroupPermissions['DecisionMakers']['picksome-write'] = true;
      $wgGroupPermissions['sysop']['picksome'] = true;
      $wgGroupPermissions['sysop']['picksome-admin'] = true;

      # Log permissions (ability to see Special:Log)
      $wgAvailableRights[] = 'view-special-log';
      $wgGroupPermissions['*']['view-special-log'] = false;
      $wgGroupPermissions['sysop']['view-special-log'] = true;

- name: Disable Special:Log for groups that don't have view-special-log
  blockinfile:
    marker: "## {mark} ANSIBLE SPECIAL LOG PERMISSIONS CONFIG"
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    block: |
      $wgHooks['SpecialPage_initList'][] = function ( &$list ) {
        global $wgUser;

        if(!$wgUser->isAllowed('view-special-log')) {
          unset( $list['Log'] );
        }
        return true;
      };

- name: Create Special:Log name overrides
  blockinfile:
    marker: "## {mark} ANSIBLE SPECIAL LOG NAME OVERRIDES CONFIG"
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    block: |
      $logTitlesOverrideMessages = [
        "picksomelogpage" => "Selection",
        "activitylogpage" => "Misc. Activity (page views, login, logout, etc)",
        "simplefavoriteslog" => "Favorites",
        "log-name-create" => "Page Creation",
        "movelogpage" => "Page Rename",
        "uploadlogpage" => "File Upload",
        "dellogpage" => "Page Deletion",
        "newuserlogpage" => "User Creation",
        "log-name-teamcomments" => "Comments",
        "torquedataconnect-apiaccesslog" => "API Accesses",
        "torquedataconnect-datachangeslog" => "Data Changes",
        "rightslog" => "Changes to Access Control / Permissions"
      ];

      $wgHooks['MessagesPreLoad'][] = function($title, &$message, $code) {
              global $logTitlesOverrideMessages;
        if(array_key_exists(strtolower($title), $logTitlesOverrideMessages)) {
          $message = $logTitlesOverrideMessages[strtolower($title)];
        }
      };

- name: Disable Special:Log types that aren't of interest
  blockinfile:
    marker: "## {mark} ANSIBLE DISABLE SPECIAL LOG TYPES CONFIG"
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    block: |
      $logTypesBlacklist = ["block", "contentmodel", "import", "managetags", "merge", "patrol", "protect", "rights", "tag"];

      $wgHooks['SetupAfterCache'][] = function () {
        global $wgLogTypes, $logTypesBlacklist;
        foreach($logTypesBlacklist as $logType) {
          unset($wgLogTypes[array_search($logType, $wgLogTypes)]);
        }

        return true;
      };

- name: Change Special:Log format slightly
  blockinfile:
    marker: "## {mark} ANSIBLE CHANGE SPECIAL LOG FORMAT CONFIG"
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    block: |
      # This is a little brittle, based on how the lines are rendered by the skin currently used
      # but should work for the foreseeable future.
      $wgHooks['LogEventsListLineEnding'][] = function ($page, &$line, &$entry, &$classes, &$attribs){
        $line = preg_replace('/(\d\d\d\d)/', '\1 &mdash;', $line, 1);
      };

- name: Rearrange Login Page
  blockinfile:
    marker: "## {mark} ANSIBLE CHANGE LOGIN ORDERING"
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    block: |
      $wgHooks['AuthChangeFormFields'][] = function ($requests, $fieldInfo, &$formDescriptor, $action) {
        if($action != \MediaWiki\Auth\AuthManager::ACTION_LOGIN) {
          return;
        }

        $formDescriptor['username']['weight'] = 200;
        $formDescriptor['password']['weight'] = 201;
        $formDescriptor['rememberMe']['weight'] = 202;
        $formDescriptor['loginattempt']['weight'] = 203;
        $formDescriptor['break'] = [
          'type' => 'info',
          'weight' => 150,
          'cssclass' => 'mw-htmlform-login-or',
          'default' => "or"
        ];

        unset($formDescriptor['linkcontainer']);
        unset($formDescriptor['passwordReset']);
        unset($formDescriptor['createOrLogin']);

        if ( isset( $formDescriptor['pluggableauthlogin'] ) ) {
          $formDescriptor['pluggableauthlogin']['weight'] = -1;
        }
      };

- name: Enable Common.css on Login Page
  blockinfile:
    marker: "## {mark} ANSIBLE ENABLE CSS ON LOGIN"
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    block: |
      $wgAllowSiteCSSOnRestrictedPages = true;

- name: Transfer Climate2030 Logo
  copy:
    src: Climate2030_Logo.png
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/resources/assets/Climate2030_Logo.png"

- name: Install Climate2030 Logo
  lineinfile:
    path: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/LocalSettings.php"
    regexp: ^\$wgLogo = .*
    line: $wgLogo = "$wgResourceBasePath/resources/assets/Climate2030_Logo.png";

- name: Transfer Common group css
  copy:
    src: Common.css
    dest: "{{ mediawiki_install_directory }}/Common.css"

- name: Install Common group css
  raw: "php {{ mediawiki_install_directory }}/mediawiki-1.33.0/maintenance/edit.php -b MediaWiki:Common.css < {{ mediawiki_install_directory }}/Common.css"

- name: Remove Common group css
  file:
    path: "{{ mediawiki_install_directory }}/Common.css"
    state: absent

- name: Transfer DecisionMakers group css
  copy:
    src: Group-DecisionMakers.css
    dest: "{{ mediawiki_install_directory }}/Group-DecisionMakers.css"

- name: Install DecisionMakers group css
  raw: "php {{ mediawiki_install_directory }}/mediawiki-1.33.0/maintenance/edit.php -b MediaWiki:Group-{{ item }}.css < {{ mediawiki_install_directory }}/Group-DecisionMakers.css"
  loop:
    - PseudoDecisionMakers
    - DecisionMakers
    - LFCEvaluators
    - LFCResearchPartners
    - LFCConsultingPartners

- name: Remove DecisionMakers group css
  file:
    path: "{{ mediawiki_install_directory }}/Group-DecisionMakers.css"
    state: absent

- name: Transfer htaccess
  copy:
    src: .htaccess
    dest: "{{ mediawiki_install_directory }}/mediawiki-1.33.0/.htaccess"

- name: Transfer wiki cheat sheet
  copy:
    src: Wiki_Markup_Cheat_Sheet
    dest: "{{ mediawiki_install_directory }}/Wiki_Markup_Cheat_Sheet"

- name: Install wiki cheat sheet
  raw: "php {{ mediawiki_install_directory }}/mediawiki-1.33.0/maintenance/edit.php -b Wiki_Markup_Cheat_Sheet < {{ mediawiki_install_directory }}/Wiki_Markup_Cheat_Sheet"

- name: Transfer wiki cheat sheet
  file:
    path: "{{ mediawiki_install_directory }}/Wiki_Markup_Cheat_Sheet"
    state: absent

# This should come near the end to make sure that all the database updates
# for the extensions get run after the rest of the system is set up.
- name: Run mediawiki updates
  command: "php {{ mediawiki_install_directory }}/mediawiki-1.33.0/maintenance/update.php"

# Handle Apache changes
- name: Symlink to webserver directory
  become_user: root
  file:
    state: link
    src: "{{ mediawiki_install_directory }}/mediawiki-1.33.0"
    path: /var/www/html/Climate2030

- name: Set permissions on attachments directory
  become_user: root
  file:
    path: "/var/www/html/Climate2030/images"
    owner: www-data
    group: www-data

- name: Restart Apache
  become_user: root
  service:
    name: apache2
    state: restarted
